<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>设备检查记录管理</title>
<link rel="stylesheet" type="text/css" href="../css/css.css" />
<link rel="stylesheet" href="../css/jqpagination.css" />
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script src="../js/jquery.jqpagination.js"></script>
<!-- <script type="text/javascript" src="js/page.js" ></script> -->
<script type="text/javascript" src="../js/init.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript">
	var page_num = 1;
	var total_num = 0;
	$(document).ready(function(){
		loadCompany();
		loadType();
	});
	
	function loadCompany(){
		$.ajax({
			sync : false,
			cache : false,
			type : 'POST',
			crossDomain : true,
			url : "../account/getAllCompany",
			data : {
			},
			dataType : "json",
			contentType : "application/x-www-form-urlencoded; charset=utf-8",
			error : function(e) {
				console.log(e);
				alert("网络错误，请重试");
			},
			success : function(data) {
				var op_de = $('<option></option>').attr('selected','selected').attr('value','-1').append("----------请选择单位----------");
				$('#company').html(op_de);
				$.each(data,function(index, value) {
					var op = $('<option></option>').attr('value',value.id).append(value.name);
					$('#company').append(op);
				});
			}
		});
	}
	
	function loadDepartment(){
		$.ajax({
			sync : false,
			cache : false,
			type : 'POST',
			crossDomain : true,
			url : "../account/getAllDepartment",
			data : {
				company : $('#company').val()
			},
			dataType : "json",
			contentType : "application/x-www-form-urlencoded; charset=utf-8",
			error : function(e) {
				console.log(e);
				alert("网络错误，请重试");
			},
			success : function(data) {
				var op_de = $('<option></option>').attr('selected','selected').attr('value','-1').append("----------请选择部门----------");
				$('#department').html(op_de);
				$.each(data,function(index, value) {
					var op = $('<option></option>').attr('value',value.id).append(value.name);
					$('#department').append(op);
				});
			}
		});
	}
	
	function list(p){
		if( $('#department').val() == -1 || $('#baseType').val()==-1 )
			return;
		$.ajax({
			sync : false,
			cache : false,
			type : 'POST',
			crossDomain : true,
			url : "list_device",
			data : {
				page : p,
				did : $('#department').val(),
				btid : $('#baseType').val()
			},
			dataType : "json",
			contentType : "application/x-www-form-urlencoded; charset=utf-8",
			error : function(e) {
				console.log(e);
				alert("网络错误，请重试");
			},
			success : function(data) {
				total_num = data.pageCount;
				page_num=p;
				$("#page_num").val(p);

				var tab_title = "<tr>"
					+ "<td width='66px' class='tdColor tdC'>序号</td>"
					+ "<td width='300px' class='tdColor'>单位</td>"
					+ "<td width='300px' class='tdColor'>部门</td>"
					+ "<td width='200px' class='tdColor'>类型</td>"
					+ "<td width='400px' class='tdColor'>设备名</td>"
					+ "<td width='330px' class='tdColor'>操作</td>"
					+ "	</tr>";
				$("#devicelist").html(tab_title);
				
				$.each(data.results,function(index, value) {
					var td_id = $('<td></td>').append(
							value.id);
					var td_cn = $('<td></td>').append(
							value.superDevice.department.company.name);
					var td_dn= $('<td></td>').append(
							value.superDevice.department.name);
					var td_dl= $('<td></td>');
					if(value.supOrSub==0)
						td_dl.append("基础");
					else
						td_dl.append("附属");
					var td_n= $('<td></td>').append(value.name);
					var a_edit = $('<a></a>').attr('href',"javascript:edit("+value.supOrSub+ ","+ value.id+");");
					a_edit.append("<img class='operation' src='../img/update.png'></a>");
					var a_del = $('<a></a>').attr('href',"javascript:del(" + value.id+");");
					a_del.append("<img class='operation' src='../img/delete.png'></a>");
					var td_op = $('<td></td>').append(a_edit).append(a_del);
					var tr = $('<tr></tr>').attr(
							'height', "40px");
					tr.append(td_id)
							.append(td_cn)
							.append(td_dn)
							.append(td_dl)
							.append(td_n)
							.append(td_op);
					$("#devicelist").append(tr);
				});
			}
		});
	}
	
	function loadType(){
		$.ajax({
			sync : false,
			cache : false,
			type : 'POST',
			crossDomain : true,
			url : "../type/list_base_type",
			data : {
			},
			dataType : "json",
			contentType : "application/x-www-form-urlencoded; charset=utf-8",
			error : function(e) {
				console.log(e);
				alert("网络错误，请重试");
			},
			success : function(data) {
				var op_de = $('<option></option>').attr('value','-1').append("-----请选择要查找的基础类型-----");
				$('#baseType').html(op_de);
				$.each(data,function(index, value) {
					var op = $('<option></option>').attr('value',value.id).append(value.name);
					$('#baseType').append(op);
				});
			}
		});
	}
	
	function del(did){
		$.ajax({
			sync : false,
			cache : false,
			type : 'POST',
			crossDomain : true,
			url : "delete_device",
			data : {
				id : did
			},
			dataType : "json",
			contentType : "application/x-www-form-urlencoded; charset=utf-8",
			error : function(e) {
				console.log(e);
				alert("网络错误，请重试");
			},
			success : function(data) {
				if(data==1){
					list(1);
				}else
					alert("不能删除该设备，该设备有关联信息！");
			}
		});
	}
	
	function edit(level,did){
		if(level == 0){
			window.location.href = "./supdevice_edit.html?id="+did;
		}else{
			window.location.href = "./subdevice_edit.html?id="+did;
		}
	}
	
	function first() {
		if (page_num == 1)
			return;
		page_num = 1;
		list(1);
	}

	function previous() {
		if (page_num == 1)
			return;
		page_num = page_num - 1;
		list(page_num);
	}

	function next() {
		if (page_num == total_num)
			return;
		page_num = page_num + 1;
		list(page_num);
	}

	function last() {
		if (page_num == total_num)
			return;
		page_num = total_num;
		list(page_num);
	}
</script>
</head>

<body>
	<div id="pageAll">
		<div class="pageTop">
			<div class="page">
				<img src="../img/coin02.png" /><span><a href="#">首页</a>&nbsp;-&nbsp;-</span>&nbsp;设备检查记录管理
			</div>
		</div>

		<div class="page">
			<!-- user页面样式 -->
			<div class="connoisseur">
			
				<div class="conform">
					<form>
						<div class="cfD">
							<select class="userinput" id="company" onchange="javascript:loadDepartment();"> </select>&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;
							<select class="userinput" id="department" onchange="javascript:list(1);"><option selected="selected" value='-1'>---------请先选择单位---------</option> </select>&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;
							<select class="userinput" id="baseType" onchange="javascript:list(1);"><option selected="selected" value='-1'></option> </select>
						</div>
					</form>
				</div>

				<!-- user 表格 显示 -->
				<div class="conShow">
					<table id="devicelist" border="1" cellspacing="0" cellpadding="0">
					</table>
				</div>
				
			</div>
			<!-- user 表格 显示 end-->
		</div>
		<!-- user页面样式end -->
	</div>

	<!-- 删除弹出框  end-->
</body>
</html>